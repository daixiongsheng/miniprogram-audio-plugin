"use strict";var t=require("dxs-utils"),i=function(){return(i=Object.assign||function(t){for(var i,n=1,o=arguments.length;n<o;n++)for(var e in i=arguments[n])Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t}).apply(this,arguments)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */if("undefined"==typeof wx)throw new Error("只支持在微信小程序使用");var n=function(){},o=0,e=function(){function i(e){var s=this;if(void 0===e&&(e={}),this.isPaused=!1,this.listener=new n,this.onPlayCallback=function(){s.listener.$emit(i.ON_PLAY)},this.onStopCallback=function(){s.listener.$emit(i.ON_STOP)},this.onPauseCallback=function(){s.listener.$emit(i.ON_PAUSE)},this.onEndedCallback=function(){s.isPlaying=!1,s.listener.$emit(i.ON_ENDED)},this.onCanplay=function(){},this.onTimeUpdateCallback=function(){var t=s.audio;s.listener.$emit(i.ON_TIME_UPDATE,t.currentTime,t.duration)},this.onError=function(t){s.isPlaying=!1,s.listener.$emit(i.ON_ERROR,t)},this.onSeeking=function(){},this.onSeeked=function(){},this.onAudioInterruptionEnd=function(){s.isPlaying&&s.audio.paused&&s.audio.play()},this.onAudioInterruptionBegin=function(){},!t.isObject(e))throw new Error("options must be an object");this.id=++o;var r=e.onPlayCallback,u=e.onPauseCallback,a=e.onStopCallback,c=e.onEndedCallback,p=e.onTimeUpdateCallback,h=e.onError;r&&this.listener.$on(i.ON_PLAY,r),u&&this.listener.$on(i.ON_PAUSE,u),a&&this.listener.$on(i.ON_STOP,a),c&&this.listener.$on(i.ON_ENDED,c),h&&this.listener.$on(i.ON_ERROR,h),p&&this.listener.$on(i.ON_TIME_UPDATE,p),this.options=Object.assign({src:"",independent:!1,autoplay:!1,loop:!1,volume:1,playbackRate:1},e),this.isPlaying=!1,this.duration=0,this.currentTime=0,this.audio=wx.createInnerAudioContext(),this.initAudio()}return Object.defineProperty(i.prototype,"paused",{get:function(){return this.audio.paused},enumerable:!1,configurable:!0}),i.prototype.initAudio=function(){this.audio.onCanplay(this.onCanplay),this.audio.onPlay(this.onPlayCallback),this.audio.onPause(this.onPauseCallback),this.audio.onStop(this.onStopCallback),this.audio.onEnded(this.onEndedCallback),this.audio.onTimeUpdate(this.onTimeUpdateCallback),this.audio.onError(this.onError),this.audio.onSeeking(this.onSeeking),this.audio.onSeeked(this.onSeeked),wx.onAudioInterruptionEnd(this.onAudioInterruptionEnd),wx.onAudioInterruptionBegin(this.onAudioInterruptionBegin),this.audio.autoplay=this.options.autoplay,this.audio.loop=this.options.loop,this.audio.playbackRate=this.options.playbackRate,this.audio.volume=this.options.volume,this.options.autoplay&&this.options.src&&this.playAudio(this.options.src)},i.prototype.playAudio=function(t){if(t||!this.options.src||!this.isPlaying||this.paused){if(this.audio.src=this.options.src=t||this.options.src,!this.options.src)throw new Error("src is required");this.duration=this.audio.duration,this.audio.play(),this.isPlaying=!0}},i.prototype.stopAudio=function(){this.isPlaying=!1,this.audio.stop()},i.prototype.pauseAudio=function(){this.isPlaying=!1,this.isPaused=!0,this.audio.pause()},i.prototype.destroy=function(){this.isPlaying=!1,this.listener.$destroy(),this.audio.destroy()},i.prototype.resumeAudio=function(){!this.isPlaying&&this.paused&&this.isPaused&&(this.isPaused=!1,this.audio.play())},i.prototype.play=function(t){return t&&this.listener.$once(i.ON_PLAY,t),this},i.prototype.stop=function(t){return t&&this.listener.$once(i.ON_STOP,t),this},i.prototype.end=function(t){return t&&this.listener.$once(i.ON_ENDED,t),this},i.prototype.pause=function(t){return t&&this.listener.$once(i.ON_PAUSE,t),this},i.prototype.timeupdate=function(t){return t&&this.listener.$once(i.ON_TIME_UPDATE,t),this},i.prototype.changeVolume=function(t){if(t<0||t>1)throw new Error("音量值错误");this.audio.volume=t,this.options.volume=t},i.prototype.changePlayRate=function(t){if(t<.5||t>2)throw new Error("音频播放值错误");this.audio.playbackRate=t,this.options.playbackRate=t},i.prototype.clearListener=function(){this.listener.$off()},i.ON_PLAY="ON_PLAY",i.ON_PAUSE="ON_PAUSE",i.ON_ENDED="ON_ENDED",i.ON_STOP="ON_STOP",i.ON_ERROR="ON_ERROR",i.ON_TIME_UPDATE="ON_TIME_UPDATE",i}(),s={src:"",independent:!1},r=0;function u(t,i,n){void 0===n&&(n=!1);var o=function t(n){return void 0===n&&(n=i),t.playAudio(n),t};return o.stop=function(i){return t.stop(i),o},o.play=function(i){return t.play(i),o},o.end=function(i){return t.end(i),o},o.pause=function(i){return t.pause(i),o},o.pauseAudio=function(){return t.pauseAudio(),o},o.stopAudio=function(){return t.stopAudio(),o},o.playAudio=function(e){return void 0===e&&(e=i),n&&e!==t.options.src&&t.clearListener(),t.playAudio(e),o},o.changeVolume=function(i){return t.changePlayRate(i),o},o.changePlayRate=function(i){return t.changePlayRate(i),o},o.resumeAudio=function(){return t.resumeAudio(),o},o}var a=0;function c(t,i){var n=Object.keys(t),o=[],s=[],r=Object.keys(i);r.forEach((function(t){return!n.includes(t)&&(i[t].independent?s.push(t):o.push(t),!0)}));var c={};return s.forEach((function(n){c[n]=function(t,i,n){var o=new e(t);return i[n]=o,u(o,t.src)}(i[n],t,n)})),o.length&&a++,o.forEach((function(n){c[n]=function(t,i,n){return u(i[n]||(i[n]=new e),t.src,!0)}(i[n],t,"shared"+a)})),r=Object.keys(c),c.resumeAudio=function(){s.forEach((function(t){c[t].resumeAudio()})),o.length&&c[o[0]].resumeAudio()},c.pauseAudio=function(){s.forEach((function(t){c[t].pauseAudio()})),o.length&&c[o[0]].pauseAudio()},c.stopAudio=function(){s.forEach((function(t){c[t].stopAudio()})),o.length&&c[o[0]].stopAudio()},1===r.length?c[r[0]]:c}function p(n){if(!this._isVue)throw new Error("目前只支持在vue实例中使用");if(void 0===n)throw new Error("options is required");if(!t.isObject(n)||"string"!=typeof n)throw new Error("options must be an object or a src string");if(t.isObject(n)&&!Object.keys(n).length)throw new Error('options cannot be an empty object, must include one of "src loop autoplay"');var o=c(this.$audioInstances||(this.$audioInstances={}),function(n){var o,e,u={},a=Object.keys(n);return"string"==typeof n?((o={})["default"+r++]=i(i({},s),{src:n,independent:!0}),o):a.includes("src")||a.includes("autoplay")||a.includes("loop")||a.includes("volume")?((e={})["default"+r++]=i(i(i({},s),n),{independent:!0}),e):(a.forEach((function(o){var e=n[o];if("string"==typeof e)u[o]=i(i({},s),{src:e});else if(t.isObject(e)){if(!Object.keys(e).length)throw new Error('options cannot be a empty object, must include one of "src loop autoplay"');u[o]=i(i({},s),e)}})),u)}(n));return o._isVue=!0,o}module.exports=function(t){n=t,Object.defineProperty(t.prototype,"$newAudio",{configurable:!1,enumerable:!1,get:function(){return p},set:function(){throw new Error("$newAudio cannot be modify")}}),t.mixin({beforeDestroy:function(){var t=this;this.$audioInstances&&(Object.keys(this.$audioInstances).forEach((function(i){var n=t.$audioInstances[i];n.destroy(),delete n[i]})),this.$audioInstances=null)}})};
